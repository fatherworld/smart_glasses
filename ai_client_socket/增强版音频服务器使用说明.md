# 🎵 增强版音频服务器使用说明

基于 `ai_client_start_stop2.c` 协议的增强版模拟AI服务器，支持音频播放、保存和转发功能。

## 🌟 新增功能

### 1. 音频播放
- **实时播放**：接收到客户端音频后立即播放
- **文件播放**：支持播放保存的WAV文件
- **音频可视化**：实时显示音频电平条

### 2. 音频保存
- **自动保存**：所有接收的音频自动保存为WAV格式
- **文件命名**：使用时间戳命名（`received_audio_20241201_143052.wav`）
- **目录管理**：统一保存到 `received_audio/` 目录

### 3. 音频转发
- **回音测试**：可将接收的音频发送回客户端
- **文件发送**：支持发送任意保存的音频文件到客户端
- **格式转换**：自动处理采样率和声道转换

### 4. 交互式控制
- **命令控制**：支持多种实时控制命令
- **状态监控**：实时显示服务器和音频状态
- **文件管理**：列表、播放、发送保存的音频文件

## 📦 环境准备

### 方法1：自动安装（推荐）
```bash
cd project/test/ai_client_socket
chmod +x setup_audio_deps.sh
./setup_audio_deps.sh
```

### 方法2：手动安装
```bash
# 安装系统依赖
sudo apt update
sudo apt install -y python3-pip python3-dev portaudio19-dev alsa-utils

# 安装Python依赖
pip3 install pyaudio numpy wave
```

## 🚀 启动服务器

### 基本启动
```bash
python3 enhanced_mock_server.py
```

### 指定地址和端口
```bash
python3 enhanced_mock_server.py --host 0.0.0.0 --port 8082
```

### 启动输出示例
```
[15:30:15.123] [SERVER] 🚀 增强版模拟AI服务器启动成功
[15:30:15.124] [SERVER] 📡 监听地址: 0.0.0.0:8082
[15:30:15.125] [SERVER] 💾 音频保存目录: /path/to/received_audio
============================================================
[15:30:15.126] [SERVER] 🎮 交互控制线程启动
[15:30:15.127] [SERVER] 💡 可用命令:
[15:30:15.128] [SERVER]    start - 发送开始录音指令
[15:30:15.129] [SERVER]    stop - 发送结束录音指令
[15:30:15.130] [SERVER]    list - 显示保存的音频文件
[15:30:15.131] [SERVER]    play <文件名> - 播放指定音频文件
[15:30:15.132] [SERVER]    send <文件名> - 发送音频文件到客户端
[15:30:15.133] [SERVER]    status - 显示服务器状态
[15:30:15.134] [SERVER]    quit - 退出服务器

> 
```

## 🎮 交互式命令

服务器运行时，可以在控制台输入以下命令：

### 基本控制
```bash
> start          # 发送开始录音指令到客户端
> stop           # 发送结束录音指令到客户端
> quit           # 退出服务器
```

### 音频文件管理
```bash
> list           # 显示所有保存的音频文件
> play received_audio_20241201_143052.wav    # 播放指定音频文件
> send received_audio_20241201_143052.wav    # 发送音频文件到客户端
```

### 状态查询
```bash
> status         # 显示服务器运行状态
```

## 📊 实时监控

### 音频电平显示
```
[15:30:20.001] [SERVER] 🎵 音频电平: [████████████░░░░░░░░] 2156
[15:30:20.051] [SERVER] 🎵 音频电平: [██████░░░░░░░░░░░░░░] 1203
[15:30:20.101] [SERVER] 🎵 音频电平: [███████████████░░░░░] 3421
```

### 发送进度显示
```
[15:30:25.100] [SERVER] 📤 发送进度: 20% (20/100)
[15:30:25.200] [SERVER] 📤 发送进度: 40% (40/100)
[15:30:25.300] [SERVER] 📤 发送进度: 60% (60/100)
[15:30:25.400] [SERVER] 📤 发送进度: 80% (80/100)
[15:30:25.500] [SERVER] 📤 发送进度: 100% (100/100)
[15:30:25.501] [SERVER] ✅ 音频文件发送完成
```

## 🔄 工作流程

### 1. 接收和播放音频
```
客户端发送音频 → 服务器接收 → 实时显示电平 → 自动保存WAV → 立即播放
```

### 2. 音频转发回客户端
```
接收完成 → 保存文件 → AI响应开始 → 发送音频到客户端 → AI响应结束
```

### 3. 手动发送音频文件
```
输入send命令 → 选择文件 → 分块发送 → 显示进度 → 发送完成
```

## 🎯 测试场景

### 场景1：基本音频收发测试
1. 启动服务器：`python3 enhanced_mock_server.py`
2. 启动客户端：`./simple_client 127.0.0.1 8082`
3. 在服务器控制台输入：`start`
4. 客户端开始录音，服务器接收并播放
5. 音频自动保存到 `received_audio/` 目录

### 场景2：音频文件管理测试
1. 录制几段音频后，输入：`list`
2. 查看保存的文件列表
3. 播放指定文件：`play received_audio_20241201_143052.wav`
4. 发送文件到客户端：`send received_audio_20241201_143052.wav`

### 场景3：回音测试
1. 客户端发送音频
2. 服务器自动将接收的音频发送回客户端
3. 客户端播放接收到的音频（实现回音效果）

## 🐛 故障排查

### PyAudio安装失败
```bash
# 方法1：系统包安装
sudo apt install python3-pyaudio

# 方法2：手动编译安装
sudo apt install portaudio19-dev python3-dev
pip3 install pyaudio

# 方法3：使用conda
conda install pyaudio
```

### 音频设备问题
```bash
# 检查音频设备
aplay -l    # 播放设备
arecord -l  # 录音设备

# 测试音频播放
speaker-test -t wav -c 2

# 测试音频录制
arecord -d 5 test.wav
aplay test.wav
```

### 权限问题
```bash
# 添加用户到audio组
sudo usermod -a -G audio $USER

# 重新登录后检查
groups $USER
```

### 端口占用
```bash
# 检查端口占用
netstat -tulpn | grep 8082

# 杀死占用进程
sudo kill -9 <PID>
```

## 📁 文件结构

```
project/test/ai_client_socket/
├── enhanced_mock_server.py          # 增强版服务器主程序
├── setup_audio_deps.sh             # 依赖安装脚本
├── 增强版音频服务器使用说明.md      # 本文档
├── received_audio/                  # 音频文件保存目录
│   ├── received_audio_20241201_143052.wav
│   ├── received_audio_20241201_143125.wav
│   └── ...
├── mock_server.py                   # 原版服务器
├── simple_client.c                  # 简化版客户端
├── ai_client_start_stop2.c          # 完整版客户端
└── ...
```

## 🔧 配置选项

### 音频参数配置
可以在 `enhanced_mock_server.py` 中修改：
```python
AUDIO_CONFIG = {
    'sample_rate': 16000,    # 采样率
    'channels': 1,           # 声道数
    'sample_width': 2,       # 采样位宽（字节）
    'chunk_size': 1024       # 缓冲区大小
}
```

### 网络参数配置
```python
chunk_size = 4096          # 网络传输块大小
timeout = 1.0              # Socket超时时间
```

## 🎉 预期效果

当一切正常工作时，您应该看到：

✅ **服务器成功启动** - 显示监听地址和控制命令  
✅ **客户端成功连接** - 显示连接信息  
✅ **音频实时接收** - 显示音频电平条  
✅ **音频自动播放** - 能听到接收的音频  
✅ **文件自动保存** - `received_audio/` 目录有WAV文件  
✅ **交互命令响应** - list、play、send等命令正常工作  
✅ **音频回传功能** - 客户端能接收并播放服务器发送的音频  

## 📞 技术支持

如果遇到问题：

1. **查看日志**：服务器会输出详细的操作日志
2. **检查依赖**：确保所有依赖包已正确安装
3. **测试音频设备**：使用系统工具测试音频功能
4. **网络连通性**：确保客户端能连接到服务器
5. **权限检查**：确保有音频设备访问权限

---

**🎊 现在您可以享受完整的音频收发、播放和保存功能了！** 