# AI客户端部署运行说明

## 项目概述
本项目是一个为RV1106B芯片设计的音频录制客户端，支持GPIO触发录音和Socket通信。

## 文件说明
- `ai_client_start_stop.c` - 主要客户端程序
- `compile.sh` - 交叉编译脚本
- `mock_server.py` - 模拟服务器程序（用于调试）
- `test_comm_argparse.h` - 简化的参数解析头文件

## 1. 编译步骤

### 1.1 准备编译环境
```bash
# 进入项目目录
cd project/test/ai_client_socket

# 给编译脚本添加执行权限
chmod +x compile.sh

# 检查交叉编译工具链是否可用
which aarch64-linux-gnu-gcc
# 或者
which arm-linux-gnueabihf-gcc
```

### 1.2 执行编译
```bash
# 执行编译脚本
./compile.sh

# 编译成功后会生成 ai_client_start_stop 可执行文件
ls -la ai_client_start_stop
```

### 1.3 编译问题排查
如果编译失败，可能的原因：
1. **缺少交叉编译工具链**
   ```bash
   # Ubuntu/Debian 安装
   sudo apt-get install gcc-aarch64-linux-gnu
   # 或者
   sudo apt-get install gcc-arm-linux-gnueabihf
   ```

2. **缺少RK媒体库**
   - 检查 `../../media/rockit/` 路径是否存在
   - 确保有相应的头文件和库文件

3. **权限问题**
   ```bash
   # 确保有执行权限
   chmod +x compile.sh
   ```

## 2. 部署到设备

### 2.1 文件传输
```bash
# 使用scp传输到设备
scp ai_client_start_stop root@<设备IP>:/tmp/

# 或者使用adb（如果支持）
adb push ai_client_start_stop /tmp/
```

### 2.2 设备上的准备工作
```bash
# 登录到设备
ssh root@<设备IP>

# 给程序添加执行权限
chmod +x /tmp/ai_client_start_stop

# 检查音频设备
cat /proc/asound/cards

# 检查GPIO调试接口
ls -la /sys/kernel/debug/gpio
```

## 3. 启动模拟服务器

### 3.1 在开发机上启动服务器
```bash
# 安装Python依赖（如果需要）
pip3 install -r requirements.txt  # 本项目无特殊依赖

# 启动模拟服务器
python3 mock_server.py --host 0.0.0.0 --port 8082
```

### 3.2 服务器使用说明
服务器启动后会显示：
```
🚀 模拟AI服务器启动成功
📡 监听地址: 0.0.0.0:8082
🎮 GPIO控制线程启动 - 可以发送录音控制指令
💡 输入命令: 'start' 开始录音, 'stop' 结束录音, 'quit' 退出
```

可用命令：
- `start` - 发送"开始录音"指令给客户端
- `stop` - 发送"结束录音"指令给客户端  
- `quit` - 退出服务器

## 4. 运行客户端程序

### 4.1 基本测试（非GPIO模式）
```bash
# 在设备上运行（测试连接）
./ai_client_start_stop --enable-upload --server <服务器IP> --port 8082

# 录音5秒并上传
./ai_client_start_stop -t 5 -o /tmp/test.pcm --enable-upload --server <服务器IP>
```

### 4.2 GPIO触发模式
```bash
# 启动GPIO触发模式
./ai_client_start_stop --enable-gpio --enable-upload --server <服务器IP> --port 8082

# 使用自定义GPIO设置
./ai_client_start_stop --enable-gpio --gpio-number 1 --gpio-poll 50 --enable-upload --server <服务器IP>
```

### 4.3 完整参数示例
```bash
# 完整的GPIO模式启动命令
./ai_client_start_stop \
  --enable-gpio \
  --enable-upload \
  --server 192.168.1.100 \
  --port 8082 \
  --format stream \
  --enable-streaming \
  --enable-timing \
  --gpio-number 1 \
  --gpio-poll 20 \
  -v 100 \
  -r 16000 \
  -c 1 \
  -b 16
```

## 5. 调试recv断开问题

### 5.1 问题现象
在GPIO模式下，客户端在 `gpio_monitor_thread` 的while循环中等待服务器消息时，recv方法总是断开连接。

### 5.2 调试步骤

#### 步骤1：网络连接检查
```bash
# 在设备上检查网络连通性
ping <服务器IP>

# 检查端口是否可达
telnet <服务器IP> 8082
```

#### 步骤2：启动服务器调试
```bash
# 启动模拟服务器
python3 mock_server.py --host 0.0.0.0 --port 8082
```

#### 步骤3：启动客户端调试
```bash
# 在另一个终端启动客户端
./ai_client_start_stop --enable-gpio --enable-upload --server <服务器IP> --port 8082
```

#### 步骤4：观察日志输出
客户端会输出详细的调试信息：
```
[时间] [CLIENT] 连接服务器成功...
[时间] [DEBUG-RECV] 开始等待socket数据...
[时间] [DEBUG-SELECT] Socket数据就绪...
```

服务器会输出：
```
[时间] [SERVER] 🔗 新客户端连接: ('客户端IP', 端口)
[时间] [SERVER] 📥 接收消息头: 类型=0x0D, 长度=XX
```

#### 步骤5：手动发送命令
在服务器控制台输入：
```
> start    # 发送开始录音指令
> stop     # 发送结束录音指令
```

### 5.3 常见问题及解决方案

#### 问题1：连接立即断开
**可能原因：**
- 服务器未启动或端口被占用
- 防火墙阻止连接
- 网络不通

**解决方法：**
```bash
# 检查服务器端口
netstat -tulpn | grep 8082

# 检查防火墙
iptables -L

# 临时关闭防火墙测试
systemctl stop iptables
```

#### 问题2：连接成功但recv阻塞
**可能原因：**
- 服务器没有发送期望的消息格式
- 消息协议不匹配

**解决方法：**
- 使用我们提供的模拟服务器进行测试
- 检查消息格式是否正确（5字节头部 + 数据）

#### 问题3：接收到数据但格式错误
**可能原因：**
- 字节序问题（大端/小端）
- 消息类型不匹配

**解决方法：**
```c
// 在客户端代码中添加更多调试信息
printf("收到消息类型: 0x%02X\n", msg_type);
printf("数据内容: %.*s\n", (int)data_len, (char*)data);
```

## 6. 性能优化建议

### 6.1 网络优化
```bash
# 设置TCP参数
echo 'net.ipv4.tcp_keepalive_time = 60' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_keepalive_intvl = 10' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_keepalive_probes = 3' >> /etc/sysctl.conf
sysctl -p
```

### 6.2 音频参数调优
```bash
# 推荐的音频参数
./ai_client_start_stop \
  --enable-gpio \
  --enable-upload \
  -r 16000 \        # 采样率16kHz
  -c 1 \            # 单声道
  -b 16 \           # 16位深度
  -v 100            # 最大音量
```

## 7. 故障排查清单

- [ ] 编译成功，生成可执行文件
- [ ] 设备网络连通性正常
- [ ] 服务器正常启动并监听端口
- [ ] 客户端能成功连接服务器
- [ ] 服务器能接收到客户端的配置消息
- [ ] GPIO控制命令能正常发送和接收
- [ ] 音频录制功能正常
- [ ] 音频数据能正常上传

## 8. 日志分析

### 8.1 客户端关键日志
```
✅ 连接服务器成功            # 连接建立
📤 发送消息: 类型=0x0D       # 配置消息发送
📡 开始等待socket数据...     # 等待GPIO控制消息
🎤 开始录音                  # 录音开始
```

### 8.2 服务器关键日志
```
🔗 新客户端连接              # 客户端连接
📥 接收消息头: 类型=0x0D     # 接收配置
📤 发送数据: 开始录音        # 发送控制指令
```

通过对比这些日志，可以定位问题出现的具体位置。 