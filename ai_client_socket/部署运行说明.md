# AIå®¢æˆ·ç«¯éƒ¨ç½²è¿è¡Œè¯´æ˜

## é¡¹ç›®æ¦‚è¿°
æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªä¸ºRV1106BèŠ¯ç‰‡è®¾è®¡çš„éŸ³é¢‘å½•åˆ¶å®¢æˆ·ç«¯ï¼Œæ”¯æŒGPIOè§¦å‘å½•éŸ³å’ŒSocketé€šä¿¡ã€‚

## æ–‡ä»¶è¯´æ˜
- `ai_client_start_stop.c` - ä¸»è¦å®¢æˆ·ç«¯ç¨‹åº
- `compile.sh` - äº¤å‰ç¼–è¯‘è„šæœ¬
- `mock_server.py` - æ¨¡æ‹ŸæœåŠ¡å™¨ç¨‹åºï¼ˆç”¨äºè°ƒè¯•ï¼‰
- `test_comm_argparse.h` - ç®€åŒ–çš„å‚æ•°è§£æå¤´æ–‡ä»¶

## 1. ç¼–è¯‘æ­¥éª¤

### 1.1 å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd project/test/ai_client_socket

# ç»™ç¼–è¯‘è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x compile.sh

# æ£€æŸ¥äº¤å‰ç¼–è¯‘å·¥å…·é“¾æ˜¯å¦å¯ç”¨
which aarch64-linux-gnu-gcc
# æˆ–è€…
which arm-linux-gnueabihf-gcc
```

### 1.2 æ‰§è¡Œç¼–è¯‘
```bash
# æ‰§è¡Œç¼–è¯‘è„šæœ¬
./compile.sh

# ç¼–è¯‘æˆåŠŸåä¼šç”Ÿæˆ ai_client_start_stop å¯æ‰§è¡Œæ–‡ä»¶
ls -la ai_client_start_stop
```

### 1.3 ç¼–è¯‘é—®é¢˜æ’æŸ¥
å¦‚æœç¼–è¯‘å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š
1. **ç¼ºå°‘äº¤å‰ç¼–è¯‘å·¥å…·é“¾**
   ```bash
   # Ubuntu/Debian å®‰è£…
   sudo apt-get install gcc-aarch64-linux-gnu
   # æˆ–è€…
   sudo apt-get install gcc-arm-linux-gnueabihf
   ```

2. **ç¼ºå°‘RKåª’ä½“åº“**
   - æ£€æŸ¥ `../../media/rockit/` è·¯å¾„æ˜¯å¦å­˜åœ¨
   - ç¡®ä¿æœ‰ç›¸åº”çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶

3. **æƒé™é—®é¢˜**
   ```bash
   # ç¡®ä¿æœ‰æ‰§è¡Œæƒé™
   chmod +x compile.sh
   ```

## 2. éƒ¨ç½²åˆ°è®¾å¤‡

### 2.1 æ–‡ä»¶ä¼ è¾“
```bash
# ä½¿ç”¨scpä¼ è¾“åˆ°è®¾å¤‡
scp ai_client_start_stop root@<è®¾å¤‡IP>:/tmp/

# æˆ–è€…ä½¿ç”¨adbï¼ˆå¦‚æœæ”¯æŒï¼‰
adb push ai_client_start_stop /tmp/
```

### 2.2 è®¾å¤‡ä¸Šçš„å‡†å¤‡å·¥ä½œ
```bash
# ç™»å½•åˆ°è®¾å¤‡
ssh root@<è®¾å¤‡IP>

# ç»™ç¨‹åºæ·»åŠ æ‰§è¡Œæƒé™
chmod +x /tmp/ai_client_start_stop

# æ£€æŸ¥éŸ³é¢‘è®¾å¤‡
cat /proc/asound/cards

# æ£€æŸ¥GPIOè°ƒè¯•æ¥å£
ls -la /sys/kernel/debug/gpio
```

## 3. å¯åŠ¨æ¨¡æ‹ŸæœåŠ¡å™¨

### 3.1 åœ¨å¼€å‘æœºä¸Šå¯åŠ¨æœåŠ¡å™¨
```bash
# å®‰è£…Pythonä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
pip3 install -r requirements.txt  # æœ¬é¡¹ç›®æ— ç‰¹æ®Šä¾èµ–

# å¯åŠ¨æ¨¡æ‹ŸæœåŠ¡å™¨
python3 mock_server.py --host 0.0.0.0 --port 8082
```

### 3.2 æœåŠ¡å™¨ä½¿ç”¨è¯´æ˜
æœåŠ¡å™¨å¯åŠ¨åä¼šæ˜¾ç¤ºï¼š
```
ğŸš€ æ¨¡æ‹ŸAIæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
ğŸ“¡ ç›‘å¬åœ°å€: 0.0.0.0:8082
ğŸ® GPIOæ§åˆ¶çº¿ç¨‹å¯åŠ¨ - å¯ä»¥å‘é€å½•éŸ³æ§åˆ¶æŒ‡ä»¤
ğŸ’¡ è¾“å…¥å‘½ä»¤: 'start' å¼€å§‹å½•éŸ³, 'stop' ç»“æŸå½•éŸ³, 'quit' é€€å‡º
```

å¯ç”¨å‘½ä»¤ï¼š
- `start` - å‘é€"å¼€å§‹å½•éŸ³"æŒ‡ä»¤ç»™å®¢æˆ·ç«¯
- `stop` - å‘é€"ç»“æŸå½•éŸ³"æŒ‡ä»¤ç»™å®¢æˆ·ç«¯  
- `quit` - é€€å‡ºæœåŠ¡å™¨

## 4. è¿è¡Œå®¢æˆ·ç«¯ç¨‹åº

### 4.1 åŸºæœ¬æµ‹è¯•ï¼ˆéGPIOæ¨¡å¼ï¼‰
```bash
# åœ¨è®¾å¤‡ä¸Šè¿è¡Œï¼ˆæµ‹è¯•è¿æ¥ï¼‰
./ai_client_start_stop --enable-upload --server <æœåŠ¡å™¨IP> --port 8082

# å½•éŸ³5ç§’å¹¶ä¸Šä¼ 
./ai_client_start_stop -t 5 -o /tmp/test.pcm --enable-upload --server <æœåŠ¡å™¨IP>
```

### 4.2 GPIOè§¦å‘æ¨¡å¼
```bash
# å¯åŠ¨GPIOè§¦å‘æ¨¡å¼
./ai_client_start_stop --enable-gpio --enable-upload --server <æœåŠ¡å™¨IP> --port 8082

# ä½¿ç”¨è‡ªå®šä¹‰GPIOè®¾ç½®
./ai_client_start_stop --enable-gpio --gpio-number 1 --gpio-poll 50 --enable-upload --server <æœåŠ¡å™¨IP>
```

### 4.3 å®Œæ•´å‚æ•°ç¤ºä¾‹
```bash
# å®Œæ•´çš„GPIOæ¨¡å¼å¯åŠ¨å‘½ä»¤
./ai_client_start_stop \
  --enable-gpio \
  --enable-upload \
  --server 192.168.1.100 \
  --port 8082 \
  --format stream \
  --enable-streaming \
  --enable-timing \
  --gpio-number 1 \
  --gpio-poll 20 \
  -v 100 \
  -r 16000 \
  -c 1 \
  -b 16
```

## 5. è°ƒè¯•recvæ–­å¼€é—®é¢˜

### 5.1 é—®é¢˜ç°è±¡
åœ¨GPIOæ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯åœ¨ `gpio_monitor_thread` çš„whileå¾ªç¯ä¸­ç­‰å¾…æœåŠ¡å™¨æ¶ˆæ¯æ—¶ï¼Œrecvæ–¹æ³•æ€»æ˜¯æ–­å¼€è¿æ¥ã€‚

### 5.2 è°ƒè¯•æ­¥éª¤

#### æ­¥éª¤1ï¼šç½‘ç»œè¿æ¥æ£€æŸ¥
```bash
# åœ¨è®¾å¤‡ä¸Šæ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping <æœåŠ¡å™¨IP>

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¯è¾¾
telnet <æœåŠ¡å™¨IP> 8082
```

#### æ­¥éª¤2ï¼šå¯åŠ¨æœåŠ¡å™¨è°ƒè¯•
```bash
# å¯åŠ¨æ¨¡æ‹ŸæœåŠ¡å™¨
python3 mock_server.py --host 0.0.0.0 --port 8082
```

#### æ­¥éª¤3ï¼šå¯åŠ¨å®¢æˆ·ç«¯è°ƒè¯•
```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨å®¢æˆ·ç«¯
./ai_client_start_stop --enable-gpio --enable-upload --server <æœåŠ¡å™¨IP> --port 8082
```

#### æ­¥éª¤4ï¼šè§‚å¯Ÿæ—¥å¿—è¾“å‡º
å®¢æˆ·ç«¯ä¼šè¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š
```
[æ—¶é—´] [CLIENT] è¿æ¥æœåŠ¡å™¨æˆåŠŸ...
[æ—¶é—´] [DEBUG-RECV] å¼€å§‹ç­‰å¾…socketæ•°æ®...
[æ—¶é—´] [DEBUG-SELECT] Socketæ•°æ®å°±ç»ª...
```

æœåŠ¡å™¨ä¼šè¾“å‡ºï¼š
```
[æ—¶é—´] [SERVER] ğŸ”— æ–°å®¢æˆ·ç«¯è¿æ¥: ('å®¢æˆ·ç«¯IP', ç«¯å£)
[æ—¶é—´] [SERVER] ğŸ“¥ æ¥æ”¶æ¶ˆæ¯å¤´: ç±»å‹=0x0D, é•¿åº¦=XX
```

#### æ­¥éª¤5ï¼šæ‰‹åŠ¨å‘é€å‘½ä»¤
åœ¨æœåŠ¡å™¨æ§åˆ¶å°è¾“å…¥ï¼š
```
> start    # å‘é€å¼€å§‹å½•éŸ³æŒ‡ä»¤
> stop     # å‘é€ç»“æŸå½•éŸ³æŒ‡ä»¤
```

### 5.3 å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1ï¼šè¿æ¥ç«‹å³æ–­å¼€
**å¯èƒ½åŸå› ï¼š**
- æœåŠ¡å™¨æœªå¯åŠ¨æˆ–ç«¯å£è¢«å ç”¨
- é˜²ç«å¢™é˜»æ­¢è¿æ¥
- ç½‘ç»œä¸é€š

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥æœåŠ¡å™¨ç«¯å£
netstat -tulpn | grep 8082

# æ£€æŸ¥é˜²ç«å¢™
iptables -L

# ä¸´æ—¶å…³é—­é˜²ç«å¢™æµ‹è¯•
systemctl stop iptables
```

#### é—®é¢˜2ï¼šè¿æ¥æˆåŠŸä½†recvé˜»å¡
**å¯èƒ½åŸå› ï¼š**
- æœåŠ¡å™¨æ²¡æœ‰å‘é€æœŸæœ›çš„æ¶ˆæ¯æ ¼å¼
- æ¶ˆæ¯åè®®ä¸åŒ¹é…

**è§£å†³æ–¹æ³•ï¼š**
- ä½¿ç”¨æˆ‘ä»¬æä¾›çš„æ¨¡æ‹ŸæœåŠ¡å™¨è¿›è¡Œæµ‹è¯•
- æ£€æŸ¥æ¶ˆæ¯æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆ5å­—èŠ‚å¤´éƒ¨ + æ•°æ®ï¼‰

#### é—®é¢˜3ï¼šæ¥æ”¶åˆ°æ•°æ®ä½†æ ¼å¼é”™è¯¯
**å¯èƒ½åŸå› ï¼š**
- å­—èŠ‚åºé—®é¢˜ï¼ˆå¤§ç«¯/å°ç«¯ï¼‰
- æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…

**è§£å†³æ–¹æ³•ï¼š**
```c
// åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­æ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯
printf("æ”¶åˆ°æ¶ˆæ¯ç±»å‹: 0x%02X\n", msg_type);
printf("æ•°æ®å†…å®¹: %.*s\n", (int)data_len, (char*)data);
```

## 6. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 6.1 ç½‘ç»œä¼˜åŒ–
```bash
# è®¾ç½®TCPå‚æ•°
echo 'net.ipv4.tcp_keepalive_time = 60' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_keepalive_intvl = 10' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_keepalive_probes = 3' >> /etc/sysctl.conf
sysctl -p
```

### 6.2 éŸ³é¢‘å‚æ•°è°ƒä¼˜
```bash
# æ¨èçš„éŸ³é¢‘å‚æ•°
./ai_client_start_stop \
  --enable-gpio \
  --enable-upload \
  -r 16000 \        # é‡‡æ ·ç‡16kHz
  -c 1 \            # å•å£°é“
  -b 16 \           # 16ä½æ·±åº¦
  -v 100            # æœ€å¤§éŸ³é‡
```

## 7. æ•…éšœæ’æŸ¥æ¸…å•

- [ ] ç¼–è¯‘æˆåŠŸï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
- [ ] è®¾å¤‡ç½‘ç»œè¿é€šæ€§æ­£å¸¸
- [ ] æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨å¹¶ç›‘å¬ç«¯å£
- [ ] å®¢æˆ·ç«¯èƒ½æˆåŠŸè¿æ¥æœåŠ¡å™¨
- [ ] æœåŠ¡å™¨èƒ½æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„é…ç½®æ¶ˆæ¯
- [ ] GPIOæ§åˆ¶å‘½ä»¤èƒ½æ­£å¸¸å‘é€å’Œæ¥æ”¶
- [ ] éŸ³é¢‘å½•åˆ¶åŠŸèƒ½æ­£å¸¸
- [ ] éŸ³é¢‘æ•°æ®èƒ½æ­£å¸¸ä¸Šä¼ 

## 8. æ—¥å¿—åˆ†æ

### 8.1 å®¢æˆ·ç«¯å…³é”®æ—¥å¿—
```
âœ… è¿æ¥æœåŠ¡å™¨æˆåŠŸ            # è¿æ¥å»ºç«‹
ğŸ“¤ å‘é€æ¶ˆæ¯: ç±»å‹=0x0D       # é…ç½®æ¶ˆæ¯å‘é€
ğŸ“¡ å¼€å§‹ç­‰å¾…socketæ•°æ®...     # ç­‰å¾…GPIOæ§åˆ¶æ¶ˆæ¯
ğŸ¤ å¼€å§‹å½•éŸ³                  # å½•éŸ³å¼€å§‹
```

### 8.2 æœåŠ¡å™¨å…³é”®æ—¥å¿—
```
ğŸ”— æ–°å®¢æˆ·ç«¯è¿æ¥              # å®¢æˆ·ç«¯è¿æ¥
ğŸ“¥ æ¥æ”¶æ¶ˆæ¯å¤´: ç±»å‹=0x0D     # æ¥æ”¶é…ç½®
ğŸ“¤ å‘é€æ•°æ®: å¼€å§‹å½•éŸ³        # å‘é€æ§åˆ¶æŒ‡ä»¤
```

é€šè¿‡å¯¹æ¯”è¿™äº›æ—¥å¿—ï¼Œå¯ä»¥å®šä½é—®é¢˜å‡ºç°çš„å…·ä½“ä½ç½®ã€‚ 